name: Compromised scanners CI

on:
    pull_request:
        paths:
            - 'compromised-packages.txt'
            - 'scripts/generate-fixtures.sh'
            - 'tests/fixtures/package-lock.*.json'
            - 'compromised.sh'
            - 'compromised.ps1'
    workflow_dispatch:

permissions:
    contents: read

jobs:
    validate-fixtures:
        name: Validate fixtures vs current list
        runs-on: ubuntu-latest
        steps:
            - name: Checkout PR head
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.sha }}

            - name: Regenerate fixtures to tmp
              run: |
                  set -euo pipefail
                  mkdir -p tmp-fixtures
                  cp scripts/generate-fixtures.sh ./tmp-fixtures/
                  bash ./tmp-fixtures/generate-fixtures.sh
                  echo "--- DIFF bad.json ---"
                  diff -u tests/fixtures/package-lock.bad.json tests/fixtures/package-lock.bad.json || true
                  echo "--- DIFF good.json ---"
                  diff -u tests/fixtures/package-lock.good.json tests/fixtures/package-lock.good.json || true

            - name: Check fixtures up-to-date
              run: |
                  set -euo pipefail
                  bash scripts/generate-fixtures.sh
                  if ! diff -u tests/fixtures/package-lock.bad.json tests/fixtures/package-lock.bad.json >/dev/null; then
                    echo "Fixture package-lock.bad.json is outdated. Run scripts/generate-fixtures.sh and commit." >&2
                    exit 1
                  fi
                  if ! diff -u tests/fixtures/package-lock.good.json tests/fixtures/package-lock.good.json >/dev/null; then
                    echo "Fixture package-lock.good.json is outdated. Run scripts/generate-fixtures.sh and commit." >&2
                    exit 1
                  fi
        outputs:
            ok: true

    linux-bash:
        name: Bash scanner (Ubuntu)
        needs: validate-fixtures
        runs-on: ubuntu-latest
        steps:
            - name: Checkout PR head
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.sha }}

            - name: Ensure executable
              run: chmod +x ./compromised.sh

            - name: Test BAD fixture (should find >=1)
              run: |
                  set -euo pipefail
                  cp tests/fixtures/package-lock.bad.json package-lock.json
                  ./compromised.sh --cache-file compromised-packages.txt --list-url https://invalid.local 2>&1 | tee bash_bad.txt
                  total=$(grep -Eo '^Total: [0-9]+' bash_bad.txt | awk '{print $2}' | tail -n1)
                  echo "Bash BAD total=${total:-nil}"
                  [[ -n "${total:-}" && "$total" -ge 1 ]]

            - name: Test GOOD fixture (should find 0)
              run: |
                  set -euo pipefail
                  cp tests/fixtures/package-lock.good.json package-lock.json
                  ./compromised.sh --cache-file compromised-packages.txt --list-url https://invalid.local 2>&1 | tee bash_good.txt
                  if grep -q '^Total: [1-9][0-9]*' bash_good.txt; then
                    echo "Expected 0 matches on GOOD fixture"; exit 1
                  fi

    windows-pwsh:
        name: PowerShell scanner (Windows)
        needs: validate-fixtures
        runs-on: windows-latest
        steps:
            - name: Checkout PR head
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.sha }}

            - name: Test BAD fixture (should find >=1)
              shell: pwsh
              run: |
                  Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
                  Copy-Item tests/fixtures/package-lock.bad.json -Destination package-lock.json -Force
                  $out = & .\compromised.ps1 -Cache "$PWD\compromised-packages.txt" -ListUrl "https://invalid.local" 2>&1
                  $out | Tee-Object -FilePath pwsh_bad.txt
                  $m = [regex]::Match(($out -join "`n"), 'Total:\s+(\d+)\s+match\(es\)')
                  if (-not $m.Success -or [int]$m.Groups[1].Value -lt 1) {
                    Write-Host ($out -join "`n")
                    throw "Expected >=1 matches on BAD fixture"
                  }

            - name: Test GOOD fixture (should find 0)
              shell: pwsh
              run: |
                  Copy-Item tests/fixtures/package-lock.good.json -Destination package-lock.json -Force
                  $out = & .\compromised.ps1 -Cache "$PWD\compromised-packages.txt" -ListUrl "https://invalid.local" 2>&1
                  $out | Tee-Object -FilePath pwsh_good.txt
                  if (($out -join "`n") -match 'Total:\s+([1-9]\d*)\s+match\(es\)') {
                    Write-Host ($out -join "`n")
                    throw "Expected 0 matches on GOOD fixture"
                  }
